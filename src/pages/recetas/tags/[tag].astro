---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import RecipeCard from "../../../components/RecipeCard.astro";
import TagFilter from "../../../components/TagFilter.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allRecipes = await getCollection("recipes");
  const uniqueTags = [
    ...new Set(allRecipes.map((recipe) => recipe.data.tags).flat()),
  ].sort();

  return uniqueTags.map((tag) => {
    const filteredRecipes = allRecipes.filter((recipe) =>
      recipe.data.tags.includes(tag)
    );
    return {
      params: { tag },
      props: { recipes: filteredRecipes, allTags: uniqueTags },
    };
  });
}

const { tag } = Astro.params;
const { recipes, allTags } = Astro.props;
---

<Layout>
  <Header />

  <main class="flex-grow container mx-auto px-4 py-12">
    <div class="text-center">
      <h1 class="text-4xl font-bold text-brand-black mb-4">
        Recetas con: <span class="text-brand-yellow">{tag}</span>
      </h1>
      <p class="text-gray-600 max-w-2xl mx-auto mb-8">
        Explora nuestras recetas etiquetadas como "{tag}".
      </p>

      <TagFilter tags={allTags} activeTag={tag} />
    </div>

    <div
      id="recipe-grid"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12"
    >
      {
        recipes.map((recipe, index) => (
          <div class={`recipe-item ${index >= 6 ? "hidden" : ""}`}>
            <RecipeCard
              title={recipe.data.title}
              description={recipe.data.description}
              image={recipe.data.image}
              slug={recipe.slug}
              tags={recipe.data.tags}
              prepTime={recipe.data.prepTime}
            />
          </div>
        ))
      }
    </div>

    {
      recipes.length > 6 && (
        <div class="text-center">
          <button
            id="load-more-btn"
            class="bg-white border-2 border-brand-black text-brand-black font-bold py-3 px-8 rounded-full hover:bg-brand-black hover:text-white transition-colors shadow-lg"
          >
            Cargar m√°s recetas
          </button>
        </div>
      )
    }

    <div class="mt-12 text-center">
      <a
        href="/recetas"
        class="text-brand-black font-semibold hover:text-brand-yellow transition-colors"
      >
        &larr; Ver todas las recetas
      </a>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  function initLoadMore() {
    const loadMoreBtn = document.getElementById("load-more-btn");

    if (loadMoreBtn) {
      // Remove existing listeners to avoid duplicates if re-initialized
      const newBtn = loadMoreBtn.cloneNode(true) as HTMLButtonElement;
      if (loadMoreBtn.parentNode) {
        loadMoreBtn.parentNode.replaceChild(newBtn, loadMoreBtn);
      }

      newBtn.addEventListener("click", () => {
        const currentlyHidden = document.querySelectorAll(
          ".recipe-item.hidden"
        );
        const itemsToShow = Array.from(currentlyHidden).slice(0, 6);

        itemsToShow.forEach((item) => {
          item.classList.remove("hidden");
          item.classList.add("animate-fade-in");
        });

        if (currentlyHidden.length <= 6) {
          newBtn.style.display = "none";
        }
      });
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLoadMore);
  } else {
    initLoadMore();
  }
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }
</style>
